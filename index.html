<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Check my workouts</title>
    <style>
    </style>
    <script lang="javascript" src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://code.jscharting.com/latest/jscharting.js"></script>

    <style>
        .hide {
            display: none;
        }

        .cat_container {}
    </style>
</head>

<body>
    <h1>Check my workouts</h1>

    <h2>Your Name:</h2>
    <input type="text" id="name">

    <div id="container"></div>

    <button id="submit">Submit</button>

    <div id="summary"></div>

    <script>
        // (async () => {
        //     const url = "https://raw.githubusercontent.com/kyocanada/check-my-workouts/master/indices.xlsx";
        //     const data = await (await fetch(url)).arrayBuffer();

        //     const workbook = XLSX.read(data);
        //     console.log("workbook.Sheets ", workbook.Sheets)

        //     const ws = XLSX.utils.sheet_to_json(workbook.Sheets.Homme)
        //     console.log(ws)

        //     var categories = []
        //     var exercices = []

        //     ws.forEach(r => {

        //         if (categories.indexOf(r.Categorie) === -1)
        //             categories.push(r.Categorie)

        //         if (exercices.indexOf(r.Exercice) === -1)
        //             exercices.push(r.Exercice)

        //     });
        //     console.log(categories)
        //     console.log(exercices)

        //     console.log(workbook.Sheets.Homme["A1"].h)

        //     var range = XLSX.utils.decode_range(workbook.Sheets.Homme['!ref'])
        //     var rowCount = range.e.r
        //     var colCount = range.e.c
        // })();


        //JSC.fetch("https://raw.githubusercontent.com/kyocanada/check-my-workouts/master/indices.csv")
        JSC.fetch("./indices.csv")
            .then(response => response.text()) // promise
            .then(text => {
                var csv = csvToJsonRegex(text)
                console.log("text", text)
                console.log("csv.json", csv)

                var cat_exes = []
                var container = document.getElementById("container")

                csv.forEach(line => {
                    var cat_exe = Object.create({ Categorie: line.Categorie, Exercice: line.Exercice })
                    var enCat = encode(line.Categorie)
                    var enExe = encode(line.Exercice)

                    console.log("", `${cat_exe.Categorie} / ${cat_exe.Exercice} : ${isCatExeInArray(cat_exes, cat_exe)}`)

                    switch (isCatExeInArray(cat_exes, cat_exe)) {
                        case 1: // Exercice et categorie existent deja

                            break;
                        case 2: // Nouvel exercice sous categorie existant
                            cat_exes.push(cat_exe)

                            var catDiv = document.getElementById(`${enCat}_container`)

                            var exeDiv = document.createElement("div")
                            exeDiv.setAttribute("id", enExe)
                            exeDiv.setAttribute("class", "exe")

                            var textExe = document.createElement("h3")
                            textExe.setHTMLUnsafe(line.Exercice)
                            exeDiv.appendChild(textExe)

                            var input = document.createElement("input")
                            input.setAttribute("type", "number")
                            input.setAttribute("id", `${enExe}_input`)
                            exeDiv.appendChild(input)

                            catDiv.appendChild(exeDiv)
                            break;

                        case 3: // Nouvelle catégorie et nouvel exercice
                            cat_exes.push(cat_exe)

                            var catContainer = document.createElement("div")
                            catContainer.setAttribute("id", `${enCat}_container`)
                            catContainer.setAttribute("class", "cat_container")
                            catContainer.setAttribute("class", "hide")

                            var textCat = document.createElement("h2")
                            textCat.setHTMLUnsafe(line.Categorie)
                            textCat.addEventListener("click", function () {
                                catContainer.classList.toggle("hide")
                            })
                            container.appendChild(textCat)

                            var exeDiv = document.createElement("div")
                            exeDiv.setAttribute("id", enExe)
                            exeDiv.setAttribute("class", "exe")

                            var textExe = document.createElement("h3")
                            textExe.setHTMLUnsafe(line.Exercice)
                            exeDiv.appendChild(textExe)

                            var input = document.createElement("input")
                            input.setAttribute("type", "number")
                            input.setAttribute("id", `${enExe}_input`)
                            exeDiv.appendChild(input)

                            console.log(catDiv)

                            catContainer.appendChild(exeDiv)
                            container.appendChild(catContainer)

                            break;

                        default:
                            break;
                    }
                });

                console.log("cat-exes", cat_exes)
            });

        function encode(str) {
            return str.replace(/[\u0300-\u036f]/g, "").replace(/ /g, "_")
        }

        function isCatExeInArray(array, cat_exe) {

            const foundCatExe = array.find((e) => cat_exe.Categorie === e.Categorie && cat_exe.Exercice === e.Exercice);
            if (typeof foundCatExe !== "undefined")
                return 1 // Exercice et categorie existent deja
            const foundCat = array.find((e) => cat_exe.Categorie == e.Categorie);
            if (typeof foundCat !== "undefined")
                return 2 // Nouvel exercice sous categorie existant
            return 3 // Nouvelle catégorie et nouvel exercice
        }




        function csvToJsonRegex(csvString) {
            const regex = /,(?=(?:[^"]*"[^"]*")*(?![^"]*"))/;
            const rows = csvString
                .split("\n");
            const headers = rows[0]
                .split(regex);
            const jsonData = [];

            for (let i = 1; i < rows.length - 1; i++) {
                const values = rows[i]
                    .split(regex);
                const obj = {};
                for (let j = 0; j < headers.length; j++) {
                    obj[headers[j]
                        .trim()] = values[j]
                }
                jsonData.push(obj);
            }

            return jsonData;
        }


    </script>
</body>

</html>
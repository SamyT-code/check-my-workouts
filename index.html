<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Check my workouts</title>
    <style>
    </style>
    <script lang="javascript" src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://code.jscharting.com/latest/jscharting.js"></script>

    <style>
        body {
            font-family: 'Helvetica'
        }

        #main {
            max-width: 900px;
        }

        h3,
        h4 {
            display: inline-block;
        }

        .hide {
            display: none;
        }

        .cat_container {}

        .red {
            color: red;
        }

        .orange {
            color: orange;
        }

        .yellow {
            color: orange;
        }

        .blue {
            color: blue;
        }

        .green {
            color: green;
        }
    </style>
</head>

<body>
    <div id="main">

        <h1>Check my workouts</h1>
        <input type="date" id="date">

        <h3>Ton nom:</h3>
        <input type="text" id="name">

        <h3 class="">Âge:</h3>
        <input type="number" id="age" value="20" class="">

        <h3>Sexe:</h3>
        <input type="checkbox" id="sexe" checked>




        <div id="container"></div>

        <button id="submit" onclick="submit()">Fini!</button>

        <div id="summary" class="hide">
            <button onclick="hideSummary()">X</button>
            <div id="container_summary"></div>
        </div>
    </div>

    <script>
        var container = document.getElementById("container")

        var input_date = document.getElementById("date")
        Date.prototype.toDateInputValue = (function () {
            var local = new Date(this);
            local.setMinutes(this.getMinutes() - this.getTimezoneOffset());
            return local.toJSON().slice(0, 10);
        });
        input_date.value = new Date().toDateInputValue();
        var input_name = document.getElementById("name")
        var input_age = document.getElementById("age")
        var input_sexe = document.getElementById("sexe")


        var summary = document.getElementById("summary")
        var container_summary = document.getElementById("container_summary")


        // (async () => {
        //     const url = "https://raw.githubusercontent.com/kyocanada/check-my-workouts/master/indices.xlsx";
        //     const data = await (await fetch(url)).arrayBuffer();

        //     const workbook = XLSX.read(data);
        //     console.log("workbook.Sheets ", workbook.Sheets)

        //     const ws = XLSX.utils.sheet_to_json(workbook.Sheets.Homme)
        //     console.log(ws)

        //     var categories = []
        //     var exercices = []

        //     ws.forEach(r => {

        //         if (categories.indexOf(r.Categorie) === -1)
        //             categories.push(r.Categorie)

        //         if (exercices.indexOf(r.Exercice) === -1)
        //             exercices.push(r.Exercice)

        //     });
        //     console.log(categories)
        //     console.log(exercices)

        //     console.log(workbook.Sheets.Homme["A1"].h)

        //     var range = XLSX.utils.decode_range(workbook.Sheets.Homme['!ref'])
        //     var rowCount = range.e.r
        //     var colCount = range.e.c
        // })();


        //JSC.fetch("https://raw.githubusercontent.com/kyocanada/check-my-workouts/master/indices.csv")
        var csv
        var cat_exes = []

        JSC.fetch("./indices.csv")
            .then(response => response.text()) // promise
            .then(text => {
                csv = csvToJsonRegex(text)
                console.log("text", text)
                console.log("csv.json", csv)


                csv.forEach(line => {
                    var cat_exe = Object.create({ Categorie: line.Categorie, Exercice: line.Exercice, Unite: line.Unite.trim() })

                    console.log("", `${cat_exe.Categorie} / ${cat_exe.Exercice} : ${isCatExeInArray(cat_exes, cat_exe)}`)

                    switch (isCatExeInArray(cat_exes, cat_exe)) {
                        case 1: // Exercice et categorie existent deja

                            break;
                        case 2: // Nouvel exercice sous categorie existant
                            cat_exes.push(cat_exe)

                            var catDiv = document.getElementById(`container_${encode(line.Categorie)}`)

                            var exeDiv = createExe(cat_exe)

                            catDiv.appendChild(exeDiv)
                            break;

                        case 3: // Nouvelle catégorie et nouvel exercice
                            cat_exes.push(cat_exe)

                            var catContainer = document.createElement("div")
                            catContainer.setAttribute("id", `container_${encode(line.Categorie)}`)
                            catContainer.setAttribute("class", "container_cat")
                            catContainer.setAttribute("class", "hide")

                            var textCat = document.createElement("h2")
                            textCat.setHTMLUnsafe(line.Categorie)
                            textCat.addEventListener("click", function () {
                                catContainer.classList.toggle("hide")
                            })
                            container.appendChild(textCat)

                            var exeDiv = createExe(cat_exe)
                            catContainer.appendChild(exeDiv)

                            container.appendChild(catContainer)

                            break;

                        default:
                            break;
                    }
                });

                console.log("cat-exes", cat_exes)
            });


        function csvToJsonRegex(csvString) {
            const regex = /,(?=(?:[^"]*"[^"]*")*(?![^"]*"))/;
            const rows = csvString
                .split("\n");
            const headers = rows[0]
                .split(regex);
            const jsonData = [];

            for (let i = 1; i < rows.length - 1; i++) {
                const values = rows[i]
                    .split(regex);
                const obj = {};
                for (let j = 0; j < headers.length; j++) {
                    obj[headers[j]
                        .trim()] = values[j]
                }
                jsonData.push(obj);
            }

            return jsonData;
        }

        function encode(str) {
            return str.replace(/[\u0300-\u036f]/g, "").replace(/ /g, "_")
        }

        function isCatExeInArray(array, cat_exe) {

            const foundCatExe = array.find((e) => cat_exe.Categorie === e.Categorie && cat_exe.Exercice === e.Exercice);
            if (typeof foundCatExe !== "undefined")
                return 1 // Exercice et categorie existent deja
            const foundCat = array.find((e) => cat_exe.Categorie == e.Categorie);
            if (typeof foundCat !== "undefined")
                return 2 // Nouvel exercice sous categorie existant
            return 3 // Nouvelle catégorie et nouvel exercice
        }

        function createExe(obj) {

            var exeDiv = document.createElement("div")
            exeDiv.setAttribute("id", encode(obj.Exercice))
            exeDiv.setAttribute("class", "exe")

            var textExe = document.createElement("h3")
            textExe.setHTMLUnsafe(obj.Exercice)
            exeDiv.appendChild(textExe)


            if (obj.Unite === "rep") {
                var input = document.createElement("input")
                input.setAttribute("type", "number")
                input.setAttribute("id", `input_${encode(obj.Exercice)}`)
                input.value = 0
                exeDiv.appendChild(input)
            }
            else if (obj.Unite === "sec") {
                var inputMin = document.createElement("input")
                inputMin.setAttribute("type", "number")
                inputMin.setAttribute("id", `input_${encode(obj.Exercice)}_min`)
                inputMin.value = 0
                exeDiv.appendChild(inputMin)


                var textMin = document.createElement("h3")
                textMin.setHTMLUnsafe("min")
                exeDiv.appendChild(textMin)

                var inputSec = document.createElement("input")
                inputSec.setAttribute("type", "number")
                inputSec.setAttribute("id", `input_${encode(obj.Exercice)}_sec`)
                inputSec.value = 0
                exeDiv.appendChild(inputSec)
                
                var textSec = document.createElement("h3")
                textSec.setHTMLUnsafe("s")
                exeDiv.appendChild(textSec)
            }

            return exeDiv
        }

        function submit() {
            container_summary.setHTMLUnsafe('')

            var age = input_age.value
            var sexe = input_sexe.checked ? 'H' : 'F'


            var textDate = document.createElement("h3")
            textDate.setHTMLUnsafe(input_date.value)
            container_summary.appendChild(textDate)

            var textNom = document.createElement("h3")
            textNom.setHTMLUnsafe(`${input_name.value} (${age}) : ${sexe}`)
            container_summary.appendChild(textNom)


            var desc = ""
            var color = ""

            cat_exes.forEach(cat_exe => {


                if (cat_exe.Unite.trim() === "rep") {

                    var exe_value = parseInt(document.getElementById(`input_${encode(cat_exe.Exercice)}`).value)

                    if (exe_value > 0) {

                        var exeDiv = document.createElement("div")
                        var textExe = document.createElement("h3")
                        textExe.setHTMLUnsafe(`${cat_exe.Exercice}: ${exe_value}`)
                        exeDiv.appendChild(textExe)
                        container_summary.appendChild(exeDiv)

                        const indices = csv.filter((i) => cat_exe.Categorie === i.Categorie && cat_exe.Exercice === i.Exercice && i.Sexe === sexe)
                        console.log(cat_exe.Categorie)
                        console.log(cat_exe.Exercice)
                        console.log(indices)

                        if (indices.length > 0) {
                            var textDesc = document.createElement("h3")
                            var indice = indices[0]

                            if (exe_value < indice.Orange) {
                                desc = "Problématique"
                                color = "red"
                            } else if (exe_value < indice.Yellow) {
                                desc = "Risques accrus"
                                color = "orange"
                            } else if (exe_value < indice.Blue) {
                                desc = "Bien"
                                color = "yellow"
                            } else if (exe_value < indice.green) {
                                desc = "Très bien"
                                color = "blue"
                            } else {
                                desc = "Excellent"
                                color = "green"
                            }
                            textDesc.setAttribute("class", color)
                            textDesc.setHTMLUnsafe(desc)
                            container_summary.appendChild(textDesc)
                        }
                    }
                } else if (cat_exe.Unite.trim() === "sec") {


                    var exe_value_min = parseInt(document.getElementById(`input_${encode(cat_exe.Exercice)}_min`).value)
                    var exe_value_sec = parseInt(document.getElementById(`input_${encode(cat_exe.Exercice)}_sec`).value)

                    if (exe_value_min > 0 || exe_value_sec > 0) {

                        var valueSec = exe_value_min * 60 + exe_value_sec

                        var exeDiv = document.createElement("div")
                        var textExe = document.createElement("h3")
                        textExe.setHTMLUnsafe(`${cat_exe.Exercice}: ${exe_value_min}:${exe_value_sec}`)
                        exeDiv.appendChild(textExe)
                        container_summary.appendChild(exeDiv)

                        const indices = csv.filter((i) => cat_exe.Categorie === i.Categorie && cat_exe.Exercice === i.Exercice && i.Sexe === sexe)

                        if (indices.length > 0) {
                            var textDesc = document.createElement("h3")
                            var indice = indices[0]

                            if (valueSec < indice.Orange) {
                                desc = "Problématique"
                                color = "red"
                            } else if (valueSec < indice.Yellow) {
                                desc = "Risques accrus"
                                color = "orange"
                            } else if (valueSec < indice.Blue) {
                                desc = "Bien"
                                color = "yellow"
                            } else if (valueSec < indice.green) {
                                desc = "Très bien"
                                color = "blue"
                            } else {
                                desc = "Excellent"
                                color = "green"
                            }
                            textDesc.setAttribute("class", color)
                            textDesc.setHTMLUnsafe(desc)
                            container_summary.appendChild(textDesc)
                        }
                    }
                }


            });

            summary.classList.remove("hide")

        }

        function hideSummary() {
            summary.classList.add("hide")
        }

    </script>
</body>

</html>